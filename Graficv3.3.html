<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/css/datepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/js/datepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/air-datepicker/2.2.3/js/i18n/datepicker.ru.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --logo-spin-duration: 10s;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulsate {
            0% { transform: scale(1); opacity: 0.9; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0.9; }
        }

        @keyframes pulseHeart {
            0% { transform: scale(1); }
            15% { transform: scale(1.1); }
            30% { transform: scale(0.9); }
            45% { transform: scale(1.05); }
            60% { transform: scale(0.95); }
            75% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        button:not(.close-modal):not(.btn-clear) {
            padding: 8px 18px !important;
            cursor: pointer;
            border: none !important;
            border-radius: 5px;
            background-color: #e0e0e0 !important;
            color: #333 !important;
            transition: all 0.2s ease;
            font-size: 13px;
            margin: 2px;
        }

body.dark-theme button:not(.close-modal):not(.btn-clear) {
    background-color: #2b5278 !important;
    color: #ffffff !important;
}

        button:not(.close-modal):not(.btn-clear):hover {
            background-color: #c8e6c9 !important;
            color: #2e7d32 !important;
        }

body.dark-theme button:not(.close-modal):not(.btn-clear):hover {
    background-color: #3d6c99 !important;
    color: #ffffff !important;
}

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #f4f4f4;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

body.dark-theme {
    background-color: #0e1621;
    color: #e1e1e1;
}

        .container {
            margin: auto;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background-color 0.3s;
            width: 100%;
            max-width: 1400px;
            box-sizing: border-box;
            flex-grow: 1;
        }

body.dark-theme .container {
    background-color: #17212b;
    box-shadow: 0 2px 5px rgba(0,0,0,0.4);
}

        .header {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            border-bottom: 1px solid #ccc;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        body.dark-theme .header {
            border-bottom-color: #555;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 2em;
            color: inherit;
            transition: color 0.3s;
        }

        body.dark-theme .header-title {
            color: #f4f4f4;
        }

        .logo {
            height: 120px;
            opacity: 0.9;
            flex-shrink: 0;
            border-radius: 50%;
            cursor: pointer;
            animation: spin var(--logo-spin-duration) linear infinite,
                       pulsate 1.6s ease-in-out infinite;
        }

        .logo:hover {
            animation: pulseHeart 1.6s ease-in-out infinite;
            animation-delay: 0.35s;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .month-navigation {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            gap: 10px;
        }

        #currentMonth {
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
        }

        #calendar {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            table-layout: fixed;
            min-width: 600px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 5px 3px;
            text-align: center;
            font-size: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        body.dark-theme th, body.dark-theme td {
            border-color: #555;
        }

        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }

body.dark-theme th {
    background-color: #2b5278;
    color: #ffffff;
}

        td:first-child, th:first-child {
            text-align: left;
            white-space: nowrap;
            min-width: 220px;
            width: 230px;
            max-width: 300px;
            position: sticky;
            left: 0;
            background-color: #fff;
            z-index: 2;
            vertical-align: middle;
            padding: 5px 10px;
            border-right: 2px solid #bbb;
        }

body.dark-theme td:first-child {
    background-color: #17212b;
    border-right-color: #2b5278;
}

        th:first-child {
            z-index: 3;
            background-color: #f2f2f2;
        }

body.dark-theme th:first-child {
    background-color: #2b5278;
    border-right-color: #2b5278;
}

        .employee-info {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            position: relative;
            min-width: 0;
        }

        .employee-number {
            display: none;
            position: absolute;
            bottom: calc(100% + 5px);
            left: 0;
            transform: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 4px 8px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 10;
            font-size: 0.8em;
            white-space: nowrap;
            pointer-events: none;
            border: 1px solid #ddd;
        }

        .employee-name {
            flex: 1;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
            padding-right: 10px;
            white-space: nowrap;
        }

        .employee-name:hover .employee-number {
            display: block;
        }

        body.dark-theme .employee-number {
            background: rgba(50, 50, 50, 0.95);
            color: #fff;
            border-color: #666;
        }

        .action-buttons { 
            display: flex;
            gap: 4px;
            flex-shrink: 0;
            margin-left: auto;
            position: relative;
            z-index: 1;
        }

        .action-buttons button {
            padding: 8px 18px !important;
            font-size: 0.95em !important;
            border: none !important;
            background-color: #4CAF50 !important;
            color: white !important;
            border-radius: 5px;
            line-height: 1;
            cursor: pointer;
            transition: background-color 0.2s;
        }

body.dark-theme .action-buttons button {
    background-color: #2b5278 !important;
    color: #ffffff !important;
}

        .action-buttons button:hover {
            background-color: #45a049 !important;
        }

body.dark-theme .action-buttons button:hover {
    background-color: #3d6c99 !important;
}

        body.dark-theme .action-buttons button {
            border-color: #555 !important;
            background-color: #4a4a4a !important;
            color: #bbb;
        }

        .action-buttons button:hover { color: #000; }
        body.dark-theme .action-buttons button:hover { color: #fff; }

        th:nth-last-child(1), td:nth-last-child(1),
        th:nth-last-child(2), td:nth-last-child(2) {
            font-weight: bold;
            min-width: 50px;
            width: 60px;
            white-space: normal;
            font-size: 10px;
        }

        .weekend { background-color: #b0b0b0; }
        .vacation { background-color: #d4edda; color: #155724; }
        .sick { background-color: #f8d7da; color: #721c24; }
        .shortened { 
            background-color: #fff3cd; 
            color: #856404; 
        }
body.dark-theme .weekend {
    background-color: #1a2633;
    color: #7d8fa1;
}
body.dark-theme .vacation {
    background-color: #1d3b2a;
    color: #4db37d;
}
body.dark-theme .sick {
    background-color: #3b1e1e;
    color: #d46c6c;
}
body.dark-theme .shortened {
    background-color: #3a2e1b;
    color: #d4b56c;
}

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 15px 20px;
            border: 1px solid #888;
            width: 95%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }

body.dark-theme .modal-content {
    background-color: #17212b;
    border-color: #2b5278;
    color: #e1e1e1;
}
body.dark-theme input,
body.dark-theme select {
    background-color: #22303d;
    border-color: #2b5278;
    color: #e1e1e1;
}

        .close-modal {
            color: #aaa;
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 26px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close-modal:hover, .close-modal:focus { color: black; }
body.dark-theme .close-modal {
    color: #7d8fa1;
}
body.dark-theme .close-modal:hover,
body.dark-theme .close-modal:focus {
    color: #ffffff;
}

        .form-group { margin-bottom: 12px; }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            font-size: 0.95em;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        .form-group-inline {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .form-group-inline > div { flex: 1; }
        .form-group-inline label { display: none; }
        .form-group-inline input[type="number"] {
            width: 80px;
            flex: 0 0 80px;
        }

        body.dark-theme .form-group input,
        body.dark-theme .form-group select {
            background-color: #555;
            border-color: #666;
            color: #f1f1f1;
        }

        .modal .action-buttons {
            justify-content: flex-end;
            margin-top: 15px;
        }

        .modal button:not(.close-modal) {
            padding: 8px 18px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.95em;
        }

        body.dark-theme .modal button:not(.close-modal) {
            background-color: #66bb6a;
        }

        .modal button:not(.close-modal):hover {
            background-color: #45a049;
        }

        body.dark-theme .modal button:not(.close-modal):hover {
            background-color: #5eac61;
        }

        #lunchModalContent { max-width: 600px; }
        #lunchTable {
            width: 100%;
            margin-bottom: 15px;
        }

        #lunchTable th,
        #lunchTable td {
            text-align: left;
            padding: 6px;
            font-size: 0.9em;
        }

        #lunchTable input[type="number"] {
            width: 50px;
            padding: 4px;
            font-size: 1em;
        }

        footer {
            text-align: center;
            padding: 15px 10px;
            margin-top: 20px;
            font-size: 0.85em;
            color: #777;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        body.dark-theme footer {
            color: #aaa;
            border-top-color: #555;
        }

        .footer-logo {
            height: 30px;
            width: 30px;
            display: inline-block;
            vertical-align: middle;
            border-radius: 50%;
        }

        #datepicker {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
        }

        .datepicker {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

body.dark-theme .datepicker {
    background: #17212b;
    border-color: #2b5278;
    color: #e1e1e1 !important;
}

        body.dark-theme .datepicker--cell {
            color: #e0e0e0 !important;
        }

        body.dark-theme .datepicker--cell.-weekend- {
            color: #ff9999 !important;
        }

        body.dark-theme .datepicker--cell.-other-month- {
            color: #888 !important;
        }

        body.dark-theme .datepicker--nav-title {
            color: #fff !important;
        }

        body.dark-theme .datepicker--nav-action path {
            fill: #fff !important;
        }

body.dark-theme .datepicker--cell.-selected- {
    background: #2b5278 !important;
}

body.dark-theme .datepicker--cell.-current- {
    background: #22303d !important;
}

        .datepicker--cell.-selected- {
            background: #4CAF50;
        }
		@media (max-width: 768px) {
            button:not(.close-modal):not(.btn-clear) {
                padding: 7px 15px !important;
                font-size: 12px !important;
            }
            
            body {
                padding: 5px;
                font-size: 13px;
            }

            .employee-name {
                max-width: 120px;
            }

            .action-buttons {
                flex-direction: column;
            }

            .container {
                padding: 10px;
            }

            .header {
                padding-bottom: 8px;
                margin-bottom: 8px;
            }

            .logo {
                height: 80px;
            }

            .controls button,
            .month-navigation button { 
                padding: 7px 15px; 
                font-size: 12px; 
            }

            #currentMonth {
                font-size: 1em;
            }

            th, td {
                font-size: 9px;
                padding: 4px 2px;
            }

            td:first-child,
            th:first-child { 
                min-width: 180px; 
                width: 200px; 
                max-width: 220px; 
                border-right-width: 1px; 
            }

            .employee-number {
                font-size: 0.8em;
            }

            .action-buttons button {
                font-size: 10px;
                padding: 1px 3px;
            }

            th:nth-last-child(1),
            td:nth-last-child(1),
            th:nth-last-child(2),
            td:nth-last-child(2) {
                min-width: 40px;
                width: 50px;
                font-size: 9px;
            }

            .modal-content {
                width: 90%;
                padding: 15px;
            }

            .form-group label {
                font-size: 0.9em;
            }

            .form-group input,
            .form-group select {
                padding: 7px 8px;
                font-size: 0.95em;
            }

            .modal button[type="submit"],
            #lunchModalContent button {
                padding: 7px 15px;
                font-size: 0.9em;
            }

            #lunchTable th,
            #lunchTable td {
                padding: 5px;
                font-size: 0.85em;
            }

            #lunchTable input[type="number"] {
                width: 45px;
            }

            .form-group-inline {
                flex-direction: column;
                gap: 5px;
                align-items: stretch;
            }

            .form-group-inline > div {
                flex: auto;
            }

            .form-group-inline input[type="number"] {
                width: 100%;
                flex: auto;
            }

            footer {
                font-size: 0.8em;
            }

            .footer-logo {
                height: 16px;
                width: 16px;
            }
        }

        @media (max-width: 480px) {
            button:not(.close-modal):not(.btn-clear) {
                padding: 6px 12px !important;
                font-size: 11px !important;
            }

            .employee-name {
                max-width: 90px;
            }

            .action-buttons button { 
                padding: 2px 4px !important; 
                font-size: 9px !important; 
            }

            .header {
                flex-direction: column;
                align-items: center;
            }

            .header-left {
                align-items: center;
            }

            .controls {
                justify-content: center;
                width: 100%;
                margin-top: 8px;
            }

            .logo {
                height: 70px;
            }

            .month-navigation {
                font-size: 0.9em;
            }

            .month-navigation button { 
                padding: 6px 12px; 
            }

            #currentMonth {
                margin: 0 5px;
            }

            th, td {
                font-size: 8px;
                padding: 3px 1px;
            }

            td:first-child,
            th:first-child { 
                min-width: 150px; 
                width: 170px; 
                max-width: 190px; 
            }

            .action-buttons button { 
                padding: 2px 6px !important; 
                font-size: 10px !important; 
            }

            .employee-number {
                display: none;
            }

            .action-buttons {
                gap: 2px;
            }

            .action-buttons button {
                font-size: 9px;
                padding: 1px 2px;
            }

            th:nth-last-child(1),
            td:nth-last-child(1),
            th:nth-last-child(2),
            td:nth-last-child(2) {
                min-width: 35px;
                width: 40px;
                font-size: 8px;
            }

            .modal-content {
                width: 98%;
                padding: 10px;
            }

            .form-group label {
                font-size: 0.85em;
            }

            .form-group input,
            .form-group select {
                padding: 6px 7px;
                font-size: 0.9em;
            }

            .modal button[type="submit"],
            #lunchModalContent button {
                padding: 6px 12px;
                font-size: 0.85em;
            }

            #lunchTable th,
            #lunchTable td {
                padding: 4px;
                font-size: 0.8em;
            }

            #lunchTable input[type="number"] {
                width: 40px;
            }

            footer {
                font-size: 0.75em;
                gap: 5px;
            }

            .footer-logo {
                height: 14px;
                width: 14px;
            }
        }
		@media print {
            body {
                background-color: #fff !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .print-header {
                display: block !important;
                text-align: center;
                font-size: 18pt;
                font-weight: bold;
                margin: 30px 0 20px;
                line-height: 1.4;
            }

            #printMonthYear {
                font-size: 16pt;
                font-weight: normal;
                text-transform: uppercase;
            }

            .container {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                max-width: 100%;
                flex-grow: 0;
                background-color: #fff !important;
            }

            .no-print {
                display: none !important;
            }

            .header {
                border: none;
                margin-bottom: 5px;
            }

            .logo {
                display: none;
            }

            #calendar {
                overflow: visible;
            }

            table {
                table-layout: auto;
                width: 100%;
                min-width: auto;
                border-color: #000 !important;
            }

            th, td {
                color: #000 !important;
                border: 1px solid #000 !important;
                background-color: #fff !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            th {
                background-color: #f2f2f2 !important;
            }

            td:first-child,
            th:first-child {
                position: static;
                background-color: #fff !important;
                min-width: auto;
                width: auto;
                max-width: none;
                border-right: 2px solid #000 !important;
            }

            .employee-info {
                color: #000 !important;
            }

            .weekend,
            .vacation,
            .sick {
                background-color: inherit !important;
            }

            .vacation::after {
                content: "";
                font-size: 0.8em;
            }

            .sick::after {
                content: "";
                font-size: 0.8em;
            }

            .print-footer {
                display: block !important;
                margin-top: 30px;
                text-align: right;
                color: #000 !important;
            }

            footer {
                display: none;
            }

            .weekend { 
                background-color: #dedede !important; 
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .vacation, .sick { 
                background-color: inherit !important; 
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω */
        #shortenedList {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }

        .shortened-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background-color: #f5f5f5;
            border-radius: 4px;
        }

        .shortened-item button {
            margin-left: 10px;
            padding: 3px 8px !important;
        }

body.dark-theme .shortened-item {
    background-color: #22303d;
    border-color: #2b5278;
}

        .shortened-display-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 3px 0;
        }
    </style>
</head>
<body>
    <audio id="heartSound" src="heart.mp3" loop></audio>
    <audio id="audioPlayer" src="pomogator.mp3"></audio>

    <div class="container">
        <div class="print-header" style="display: none;">
            –ì–†–ê–§–ò–ö –°–õ–ï–°–ê–†–ï–ô-–†–ï–ú–û–ù–¢–ù–ò–ö–û–í –†–ú–¶, –£–ß–ê–°–¢–û–ö –ü–û –†–ï–ú–û–ù–¢–£ –û–ë–û–†–£–î–û–í–ê–ù–ò–Ø –õ–†–ü<br>
            (<span id="printMonthYear"></span>)
        </div>

        <div class="header">
            <div class="header-left">
                <img src="img/logo1.png" class="logo" alt="–õ–æ–≥–æ—Ç–∏–ø" 
                     onerror="this.src='https://placehold.co/150x60/cccccc/333333?text=Logo+Error'; this.onerror=null;"
                     onmouseenter="document.getElementById('heartSound').play()"
                     onmouseleave="document.getElementById('heartSound').pause()">
                <h1 class="header-title no-print" onclick="document.getElementById('audioPlayer').play()">–ü–æ–º–æ–≥–∞—Ç–æ—Ä V3.3</h1>
                <div class="controls no-print">
                    <button onclick="openEditModal(-1)">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
                    <button onclick="exportToFile()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="document.getElementById('fileInput').click()">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                    <button onclick="exportTable()">üìä Excel (.xlsx)</button>
                    <button onclick="window.print()">üñ® –ü–µ—á–∞—Ç—å</button>
                    <button onclick="toggleTheme()">üåì –¢–µ–º–∞</button>
                    <button id="lunchSettingsBtn">üçΩÔ∏è –û–±–µ–¥</button>
                </div>
            </div>
        </div>

        <div class="month-navigation no-print">
            <button onclick="changeMonth(-1)">‚Üê –ü—Ä–µ–¥—ã–¥—É—â–∏–π</button>
            <div id="currentMonth"></div>
            <button onclick="changeMonth(1)">–°–ª–µ–¥—É—é—â–∏–π ‚Üí</button>
        </div>

        <div id="calendar"></div>

        <div class="print-footer" style="display: none;">
            <p>–ì—Ä–∞—Ñ–∏–∫ —É—Ç–≤–µ—Ä–¥–∏–ª: _______________________________________</p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal('editModal')">&times;</span>
            <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–º</h3>
            <form onsubmit="handleEmployeeForm(event)">
                <div class="form-group">
                    <label>–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä:</label>
                    <input type="text" id="employeeNumber" required>
                </div>
                <div class="form-group">
                    <label>–§–ò–û:</label>
                    <input type="text" id="employeeName" required>
                </div>
                <div class="form-group">
                    <label>–ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã:</label>
                    <select id="scheduleType" required>
                        <option value="5days">5/2 –î–Ω–µ–≤–Ω–æ–π (8:00-17:00)</option>
                        <option value="2/2">–°–º–µ–Ω—ã 2/2 (2–î/2–í)</option>
                        <option value="2/2/4">–°–º–µ–Ω—ã 2–î/2–ù/4–í</option>
                        <option value="3/3">3/3 (3 —Ä–∞–±–æ—á–∏—Ö/3 –≤—ã—Ö–æ–¥–Ω—ã—Ö)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã:</label>
                    <input type="date" id="startDate" required>
                </div>
                <div class="form-group">
                    <label>–û—Ç–ø—É—Å–∫ (–Ω–∞—á–∞–ª–æ - –¥–Ω–µ–π):</label>
                    <div class="form-group-inline">
                        <div><input type="date" id="vacationStart"></div>
                        <div><input type="number" id="vacationDays" min="1" placeholder="–î–Ω–µ–π"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>–ë–æ–ª—å–Ω–∏—á–Ω—ã–π (–Ω–∞—á–∞–ª–æ - –∫–æ–Ω–µ—Ü):</label>
                    <div class="form-group-inline">
                        <div><input type="date" id="sickStart"></div>
                        <div><input type="date" id="sickEnd"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>–í—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏:
                        <button type="button" onclick="openDatepicker()" style="margin-left:10px;">üìÖ –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—ã</button>
                    </label>
                    <input type="text" id="customDaysOff" placeholder="–î–î.–ú–ú.–ì–ì–ì–ì —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
                </div>
                <div class="form-group">
                    <label>–ù–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–º–µ–Ω—ã (—á–∞—Å—ã):
                       <button type="button" onclick="openShortenedModal()" 
        style="margin-left:10px;"
        ${currentEmployeeIndex === -1 ? 'disabled' : ''}>
    ‚è±Ô∏è –í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—ã
</button>
                    </label>
                    <div id="shortenedShiftsDisplay" style="margin-top:5px; font-size:0.9em;"></div>
                </div>
                <div class="action-buttons">
                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <div id="lunchModal" class="modal">
        <div class="modal-content" id="lunchModalContent">
            <span class="close-modal" onclick="closeModal('lunchModal')">&times;</span>
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–µ–¥–µ–Ω–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏</h3>
            <table id="lunchTable">
                <thead>
                    <tr>
                        <th>–ì—Ä–∞—Ñ–∏–∫</th>
                        <th>–¢–∏–ø —Å–º–µ–Ω—ã</th>
                        <th>–û–±–µ–¥ 1, –º–∏–Ω</th>
                        <th>–û–±–µ–¥ 2, –º–∏–Ω</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>5/2 –î–Ω–µ–≤–Ω–æ–π</td>
                        <td>–î–Ω–µ–≤–Ω–∞—è</td>
                        <td><input type="number" value="60" data-schedule="5days-day-1" class="lunch-time-input"></td>
                        <td><input type="number" value="0" data-schedule="5days-day-2" class="lunch-time-input"></td>
                    </tr>
                    <tr>
                        <td>–°–º–µ–Ω—ã 2/2</td>
                        <td>–î–Ω–µ–≤–Ω–∞—è</td>
                        <td><input type="number" value="30" data-schedule="2/2-day-1" class="lunch-time-input"></td>
                        <td><input type="number" value="0" data-schedule="2/2-day-2" class="lunch-time-input"></td>
                    </tr>
                    <tr>
                        <td>–°–º–µ–Ω—ã 2/2/4</td>
                        <td>–î–Ω–µ–≤–Ω–∞—è</td>
                        <td><input type="number" value="30" data-schedule="2/2/4-day-1" class="lunch-time-input"></td>
                        <td><input type="number" value="0" data-schedule="2/2/4-day-2" class="lunch-time-input"></td>
                    </tr>
                    <tr>
                        <td>–°–º–µ–Ω—ã 2/2/4</td>
                        <td>–ù–æ—á–Ω–∞—è</td>
                        <td><input type="number" value="30" data-schedule="2/2/4-night-1" class="lunch-time-input"></td>
                        <td><input type="number" value="0" data-schedule="2/2/4-night-2" class="lunch-time-input"></td>
                    </tr>
                    <tr>
                        <td>3/3</td>
                        <td>–î–Ω–µ–≤–Ω–∞—è</td>
                        <td><input type="number" value="30" data-schedule="3/3-day-1" class="lunch-time-input"></td>
                        <td><input type="number" value="0" data-schedule="3/3-day-2" class="lunch-time-input"></td>
                    </tr>
                </tbody>
            </table>
            <button onclick="saveLunchSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
    </div>

    <div id="datepickerModal" class="modal">
        <div class="modal-content" style="max-width: 320px;">
            <span class="close-modal" onclick="closeModal('datepickerModal')">&times;</span>
            <h3 style="margin-bottom: 15px;">–í—ã–±–µ—Ä–∏—Ç–µ –≤—ã—Ö–æ–¥–Ω—ã–µ –¥–Ω–∏</h3>
            <div id="datepicker"></div>
            <div style="margin-top: 15px;">
                <button onclick="addSelectedDates()" style="padding: 8px 15px; margin-right: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="clearSelectedDates()" class="btn-clear">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
        </div>
    </div>

<div id="shortenedModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <span class="close-modal" onclick="closeModal('shortenedModal')">&times;</span>
        <h3>–°–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã</h3>
        
        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="form-group">
            <label>–î–∞—Ç–∞:</label>
            <input type="date" id="shortenedDate" class="shortened-input">
        </div>
        <div class="form-group">
            <label>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</label>
            <input type="number" id="shortenedHours" min="0" max="12" step="0.5" value="7" 
                   class="shortened-input">
        </div>
        <button onclick="addShortenedShift()" id="addShortenedBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
        
        <!-- –°–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∑–∞–ø–∏—Å–µ–π -->
        <div id="shortenedList" style="margin-top: 15px; max-height: 300px; overflow-y: auto;">
            <!-- –ó–∞–ø–∏—Å–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å -->
        </div>
        
        <div style="margin-top: 15px; display: flex; gap: 10px;">
            <button onclick="closeModal('shortenedModal')">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>
</div>

    <input type="file" id="fileInput" hidden accept=".json">

    <footer class="no-print">
        <img src="img/logo.png" class="footer-logo" alt="–õ–æ–≥–æ—Ç–∏–ø">
        ¬© NeBOLTaY –¢—Ä—ã—Ü-–¢—ã—Ü –ü–æ–º–æ–≥–∞—Ç–æ—Ä, 2025
    </footer>

    <script>
        let currentDate = new Date();
        let employees = [];
        let currentEmployeeIndex = null;
        let lunchSettings = {};
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", 
                          "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        let selectedDates = [];
        let currentDateInput = null;
        let currentShortenedEmployee = null;
        let currentShortenedDates = [];

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
        function migrateData(data) {
            if (!data.version) {
                console.log("–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–µ—Ä—Å–∏–∏ 1");
                return {
                    version: 3,
                    employees: data.map(emp => ({
                        number: emp.number || '',
                        name: emp.name,
                        scheduleType: emp.scheduleType || '5days',
                        startDate: emp.startDate || new Date().toISOString(),
                        vacation: emp.vacation || [],
                        sickLeaves: emp.sickLeaves || [],
                        customDaysOff: emp.customDaysOff || [],
                        shortenedShifts: {}
                    })),
                    lunchSettings: {}
                };
            }
            if (data.version === 2) {
                console.log("–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–µ—Ä—Å–∏–∏ 2");
                return {
                    version: 3,
                    employees: data.employees,
                    lunchSettings: data.lunchSettings || {}
                };
            }
            return data;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö —Ä–∞–±–æ—Ç–Ω–∏–∫–∞
        function validateEmployee(emp) {
            if (!emp || typeof emp !== 'object') {
                console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ä–∞–±–æ—Ç–Ω–∏–∫–∞", emp);
                return false;
            }
            
            const requiredFields = ['name', 'scheduleType', 'startDate'];
            for (const field of requiredFields) {
                if (!emp[field]) {
                    console.error(`–£ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ: ${field}`, emp);
                    return false;
                }
            }
            
            if (isNaN(new Date(emp.startDate).getTime())) {
                console.error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —É —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ ${emp.name}`, emp);
                return false;
            }
            
            return true;
        }

        class Employee {
constructor({ 
    number, 
    name, 
    scheduleType, 
    startDate, 
    vacation = [], 
    sickLeaves = [], 
    customDaysOff = [],
    shortenedShifts = {},
    carryOverHours = {}  // –î–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤–æ–µ –ø–æ–ª–µ
}) {
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                if (!name) throw new Error("–ù–µ —É–∫–∞–∑–∞–Ω–æ –∏–º—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞");
                
                this.number = number || '';
                this.name = name;
                this.scheduleType = scheduleType || '5days';
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞—Ç—ã –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
                try {
                    this.startDate = new Date(startDate);
                    if (isNaN(this.startDate.getTime())) {
                        console.warn(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–ª—è ${name}, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞`);
                        this.startDate = new Date();
                    }
                } catch (e) {
                    console.warn(`–û—à–∏–±–∫–∞ –≤ –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞ –¥–ª—è ${name}, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞`, e);
                    this.startDate = new Date();
                }
                this.startDate.setUTCHours(0, 0, 0, 0);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—É—Å–∫–æ–≤
this.vacation = vacation.map(p => ({
    start: this.parseDate(p.start),
    end: p.end ? this.parseDate(p.end) : this.parseDate(p.start)
})).filter(p => p.start);

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–æ–ª—å–Ω–∏—á–Ω—ã—Ö
this.sickLeaves = sickLeaves.map(p => ({
    start: this.parseDate(p.start),
    end: p.end ? this.parseDate(p.end) : this.parseDate(p.start)
})).filter(p => p.start);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã—Ö–æ–¥–Ω—ã—Ö
                this.customDaysOff = customDaysOff
                    .map(d => this.parseDate(d))
                    .filter(d => d)
                    .map(d => d.toISOString().split('T')[0]);
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω
this.shortenedShifts = {};
Object.entries(shortenedShifts || {}).forEach(([date, hours]) => {
    const parsedDate = this.parseDate(date);
    if (parsedDate) {
        this.shortenedShifts[parsedDate.toISOString().split('T')[0]] = hours;
    }
});

// –î–æ–±–∞–≤–∏–ª–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã—Ö —á–∞—Å–æ–≤
this.carryOverHours = carryOverHours;
            }
getMonthKey(date) {
    const d = new Date(date);
    return `${d.getUTCFullYear()}-${d.getUTCMonth()}`;
}

getNextMonthKey(date) {
    const d = new Date(date);
    d.setUTCMonth(d.getUTCMonth() + 1);
    return `${d.getUTCFullYear()}-${d.getUTCMonth()}`;
}

isLastDayOfMonth(date) {
    const d = new Date(date);
    return d.getUTCDate() === new Date(d.getUTCFullYear(), d.getUTCMonth() + 1, 0).getUTCDate();
}
            // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç
parseDate(dateStr) {
    if (!dateStr) return null;
    
    // –ü–∞—Ä—Å–∏–Ω–≥ ISO —Ñ–æ—Ä–º–∞—Ç–∞ "2024-05-01"
    const isoMatch = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (isoMatch) {
        return new Date(Date.UTC(isoMatch[1], isoMatch[2]-1, isoMatch[3]));
    }
    
    // –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–æ—Ä–º–∞—Ç–∞ "01.05.2024"
    const dmyMatch = dateStr.match(/^(\d{2})\.(\d{2})\.(\d{4})/);
    if (dmyMatch) {
        return new Date(Date.UTC(dmyMatch[3], dmyMatch[2]-1, dmyMatch[1]));
    }
    
    // –ü–∞—Ä—Å–∏–Ω–≥ –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤
    try {
        const date = new Date(dateStr);
        if (!isNaN(date.getTime())) {
            date.setUTCHours(0, 0, 0, 0);
            return date;
        }
    } catch (e) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –¥–∞—Ç—É:", dateStr, e);
    }
    
    return null;
}

            isCustomDayOff(date) {
                const checkDate = new Date(date);
                checkDate.setHours(0, 0, 0, 0);
                return this.customDaysOff.some(d => {
                    const storedDate = new Date(d);
                    storedDate.setHours(0, 0, 0, 0);
                    return storedDate.getTime() === checkDate.getTime();
                });
            }

isVacation(date) {
    const checkDate = new Date(date);
    checkDate.setUTCHours(0, 0, 0, 0);
    
    return this.vacation.some(p => {
        const start = new Date(p.start);
        start.setUTCHours(0, 0, 0, 0);
        
        let end = p.end ? new Date(p.end) : start;
        end.setUTCHours(0, 0, 0, 0);
        
        return checkDate >= start && checkDate <= end;
    });
}

isSick(date) {
    const checkDate = new Date(date);
    checkDate.setUTCHours(0, 0, 0, 0);
    
    return this.sickLeaves.some(p => {
        const start = new Date(p.start);
        start.setUTCHours(0, 0, 0, 0);
        
        let end = p.end ? new Date(p.end) : start;
        end.setUTCHours(0, 0, 0, 0);
        
        return checkDate >= start && checkDate <= end;
    });
}

            getShift(date) {
    try {
        const checkDate = new Date(date);
        if (isNaN(checkDate.getTime())) {
            console.warn("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞:", date);
            return '';
        }
        
        checkDate.setUTCHours(0, 0, 0, 0);
        const checkDateStr = checkDate.toISOString().split('T')[0];
        
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã–µ —Å–º–µ–Ω—ã
        if (this.shortenedShifts[checkDateStr] !== undefined) {
            return this.shortenedShifts[checkDateStr];
        }
        
        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ
        if (this.isCustomDayOff(checkDateStr)) return '';
        
        // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–æ–ª—å–Ω–∏—á–Ω—ã–π
        if (this.isSick(checkDateStr)) return '–ë';
        
        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–ø—É—Å–∫
        if (this.isVacation(checkDateStr)) return '–û';
        
        // 5. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –¥–∞—Ç–∞ –Ω–µ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
        const startDate = new Date(this.startDate);
        startDate.setUTCHours(0, 0, 0, 0);
        if (checkDate < startDate) return '';
        
        // 6. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–º–µ–Ω—É –ø–æ –≥—Ä–∞—Ñ–∏–∫—É
        const diffTime = checkDate - startDate;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        
        switch (this.scheduleType) {
            case '5days':
                return (diffDays % 7 < 5) ? '8' : '';
            case '2/2':
                return (diffDays % 4 < 2) ? '–î' : '';
            case '2/2/4':
                const cycle = diffDays % 8;
                return cycle < 2 ? '–î' : cycle < 4 ? '–ù' : '';
            case '3/3':
                return (diffDays % 6 < 3) ? '–î' : '';
            default:
                return '';
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –≤ getShift:", e);
        return '';
    }
}

getHours(date) {
    const checkDate = new Date(date).toISOString().split('T')[0];
    
    // –î–æ–±–∞–≤–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã—Ö —á–∞—Å–æ–≤
    const monthKey = this.getMonthKey(date);
    let carryOver = this.carryOverHours[monthKey] || 0;
    delete this.carryOverHours[monthKey];

    // –î–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–Ω—ã—Ö —Å–º–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –µ—Å—Ç—å
    if (this.shortenedShifts[checkDate] !== undefined) {
        return this.shortenedShifts[checkDate] + carryOver;
    }
    
    const shift = this.getShift(date);
    if (!shift || shift === '–ë' || shift === '–û') return 0;
    
    // –î–ª—è –æ–±—ã—á–Ω—ã—Ö —Å–º–µ–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞—Å—á–µ—Ç
    let baseHours = 0;
    let shiftType = 'day';
    
    switch (this.scheduleType) {
        case '5days':
            baseHours = 9;
            shiftType = 'day';
            break;
        case '2/2':
            baseHours = 12;
            shiftType = 'day';
            break;
        case '2/2/4':
            baseHours = 12;
            shiftType = shift === '–ù' ? 'night' : 'day';
            break;
        case '3/3':
            baseHours = 12;
            shiftType = 'day';
            break;
    }

const lunch1 = lunchSettings[`${this.scheduleType}-${shiftType}-1`] || 0;
    const lunch2 = lunchSettings[`${this.scheduleType}-${shiftType}-2`] || 0;
    let totalHours = baseHours - (lunch1 + lunch2)/60;

    // –î–æ–±–∞–≤–∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –º–µ—Å—è—Ü–∞ –¥–ª—è –Ω–æ—á–Ω—ã—Ö —Å–º–µ–Ω
    if (shift === '–ù' && this.isLastDayOfMonth(date)) {
        const nextMonthKey = this.getNextMonthKey(date);
        const hoursForCurrentMonth = 4;
        const hoursToCarry = totalHours - hoursForCurrentMonth;
        
        this.carryOverHours[nextMonthKey] = (this.carryOverHours[nextMonthKey] || 0) + hoursToCarry;
        totalHours = hoursForCurrentMonth;
    }

    return totalHours + carryOver;
}
        }

        function generateCalendar() {
            const month = currentDate.getUTCMonth();
            const year = currentDate.getUTCFullYear();
            
            document.getElementById('printMonthYear').textContent = 
                `${monthNames[month]} ${year} –≥.`.toUpperCase();
            
            const calendarDiv = document.getElementById('calendar');
            calendarDiv.innerHTML = '';
            
            const daysInMonth = new Date(Date.UTC(year, month + 1, 0)).getUTCDate();
            
            document.getElementById('currentMonth').textContent = `${monthNames[month]} ${year}`.toUpperCase();
            
            const table = document.createElement('table');
            const thead = table.createTHead();
            const tbody = table.createTBody();
            
            const headerRow = thead.insertRow();
            headerRow.innerHTML = '<th>–†–∞–±–æ—Ç–Ω–∏–∫</th>' + 
                Array.from({length: daysInMonth}, (_, i) => {
                    const date = new Date(Date.UTC(year, month, i + 1));
                    const isWeekend = [0,6].includes(date.getUTCDay());
                    return `<th class="${isWeekend ? 'weekend' : ''}">${i + 1}</th>`;
                }).join('') + 
                '<th>–í—Å–µ–≥–æ —Å–º–µ–Ω</th><th>–ò—Ç–æ–≥–æ —á–∞—Å–æ–≤</th>';

            employees.sort((a, b) => (a.number || '').localeCompare(b.number || '', undefined, {numeric: true}));

            employees.forEach((employee, index) => {
                const row = tbody.insertRow();
                const nameCell = row.insertCell();
                nameCell.innerHTML = `
                    <div class="employee-info">
                        <span class="employee-name" title="–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä: ${employee.number || 'N/A'}">
                            ${employee.name}
                            <span class="employee-number">‚Ññ${employee.number || 'N/A'}</span>
                        </span>
                        <div class="action-buttons no-print">
                            <button class="btn-edit" onclick="openEditModal(${index})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
                            <button class="btn-delete" onclick="deleteEmployee(${index})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        </div>
                    </div>
                `;

                let totalShifts = 0;
                let totalHours = 0;

                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(Date.UTC(year, month, day));
                    const cell = row.insertCell();
                    const shift = employee.getShift(date);
                    cell.textContent = shift;

                    if (typeof shift === 'number') {
                        cell.classList.add('shortened');
                        cell.title = `–°–æ–∫—Ä–∞—â–µ–Ω–Ω–∞—è —Å–º–µ–Ω–∞: ${shift} —á–∞—Å–æ–≤`;
                    }

                    if (shift && shift !== '–ë' && shift !== '–û') {
                        totalShifts++;
                        totalHours += employee.getHours(date);
                    }

                    if (employee.isVacation(date)) cell.classList.add('vacation');
                    if (employee.isSick(date)) cell.classList.add('sick');
                    const isWeekend = [0,6].includes(date.getUTCDay());
                    if (isWeekend) cell.classList.add('weekend');
                }

                row.insertCell().textContent = totalShifts;
                // –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–µ–¥ –≤—Å—Ç–∞–≤–∫–æ–π —è—á–µ–π–∫–∏ —Å —á–∞—Å–∞–º–∏
const prevMonthDate = new Date(Date.UTC(year, month, 1));
prevMonthDate.setUTCMonth(prevMonthDate.getUTCMonth() - 1);
const prevMonthKey = employee.getMonthKey(prevMonthDate);
totalHours += employee.carryOverHours[prevMonthKey] || 0;

row.insertCell().textContent = totalHours.toFixed(1);
            });

            calendarDiv.appendChild(table);
        }

        function changeMonth(offset) {
            currentDate.setMonth(currentDate.getMonth() + offset);
            generateCalendar();
        }

        function openEditModal(index = -1) {
    currentShortenedEmployee = index !== -1 ? employees[index] : null; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    try {
        currentEmployeeIndex = index;
        const modal = document.getElementById('editModal');
        if (!modal) {
            console.error('–ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ editModal –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
            return;
        }
                
                const form = modal.querySelector('form');
                if (!form) {
                    console.error('–§–æ—Ä–º–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
                    return;
                }
                
                form.reset();

                if (index === -1) {
                    modal.querySelector('h3').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞';
                } else {
                    modal.querySelector('h3').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞';
                    const emp = employees[index];
                    
                    document.getElementById('employeeNumber').value = emp.number;
                    document.getElementById('employeeName').value = emp.name;
                    document.getElementById('scheduleType').value = emp.scheduleType;
                    document.getElementById('startDate').value = emp.startDate.toISOString().split('T')[0];
                    
                    if (emp.vacation.length > 0) {
    const vacation = emp.vacation[0];
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD –¥–ª—è input[type=date]
    const startDate = new Date(vacation.start);
    const startDateISO = startDate.toISOString().split('T')[0];
    document.getElementById('vacationStart').value = startDateISO;
    
    if (vacation.end) {
        const endDate = new Date(vacation.end);
        const diffDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        document.getElementById('vacationDays').value = diffDays;
    }
}
                    
if (emp.sickLeaves.length > 0) {
    const sickLeave = emp.sickLeaves[0];
    const start = new Date(sickLeave.start);
    const end = new Date(sickLeave.end);
    document.getElementById('sickStart').value = start.toISOString().split('T')[0];
    document.getElementById('sickEnd').value = end.toISOString().split('T')[0];
}
                    
                    document.getElementById('customDaysOff').value = emp.customDaysOff
                        .map(d => {
                            const date = new Date(d);
                            return `${String(date.getUTCDate()).padStart(2, '0')}.${String(date.getUTCMonth() + 1).padStart(2, '0')}.${date.getUTCFullYear()}`;
                        }).join(', ');

                    const displayDiv = document.getElementById('shortenedShiftsDisplay');
if (displayDiv) {
    displayDiv.innerHTML = Object.entries(emp.shortenedShifts)
        .map(([date, hours]) => {
            const utcDate = new Date(date + 'T00:00:00Z');
            const localDate = new Date(utcDate.getTime() - utcDate.getTimezoneOffset() * 60000);
            const day = localDate.getDate().toString().padStart(2, '0');
            const month = (localDate.getMonth() + 1).toString().padStart(2, '0');
            const year = localDate.getFullYear();
            return `
                <div class="shortened-display-item">
                    ${day}.${month}.${year}: ${hours}—á
                    <button onclick="deleteShortenedDisplay('${date}')" class="no-print">üóëÔ∏è</button>
                </div>
            `;
        }).join('');
}
                }

                modal.style.display = 'flex';
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤ openEditModal:', error);
            }
        }
function deleteShortenedDisplay(dateKey) {
    if (!currentShortenedEmployee) {
        console.error("–ù–µ –≤—ã–±—Ä–∞–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
        return;
    }
  if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        delete currentShortenedEmployee.shortenedShifts[dateKey];
        openEditModal(currentEmployeeIndex); // –ü–µ—Ä–µ–æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        saveData();
        generateCalendar();
    }
}
function handleEmployeeForm(e) {
    e.preventDefault();
    
    const formData = {
        number: document.getElementById('employeeNumber').value.trim(),
        name: document.getElementById('employeeName').value.trim(),
        scheduleType: document.getElementById('scheduleType').value,
        startDate: document.getElementById('startDate').value,
        vacation: [],
        sickLeaves: [],
        customDaysOff: document.getElementById('customDaysOff').value.split(',').map(d => d.trim()).filter(d => d),
        shortenedShifts: currentShortenedEmployee ? currentShortenedEmployee.shortenedShifts : {}
    };

            const vacationStart = document.getElementById('vacationStart').value;
            const vacationDays = parseInt(document.getElementById('vacationDays').value, 10);
            if (vacationStart && vacationDays > 0) {
			if (isNaN(new Date(vacationStart).getTime())) {
        alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –¥–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –æ—Ç–ø—É—Å–∫–∞");
        return;
    }
                if (vacationStart && vacationDays > 0) {
    const startDate = new Date(vacationStart);
    startDate.setUTCHours(0, 0, 0, 0);
    const endDate = new Date(startDate);
    endDate.setUTCDate(startDate.getUTCDate() + vacationDays - 1);
    
    formData.vacation.push({
        start: startDate.toISOString(),
        end: endDate.toISOString()
    });
}}

            const sickStart = document.getElementById('sickStart').value;
            const sickEnd = document.getElementById('sickEnd').value;
            if (sickStart && sickEnd) {
			if (isNaN(new Date(sickStart).getTime()) || isNaN(new Date(sickEnd).getTime())) {
        alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞—Ç—ã –±–æ–ª—å–Ω–∏—á–Ω–æ–≥–æ");
        return;
    }
               if (sickStart && sickEnd) {
    const start = new Date(sickStart);
    start.setUTCHours(0, 0, 0, 0);
    const end = new Date(sickEnd);
    end.setUTCHours(0, 0, 0, 0);
    
    if (end >= start) {
        formData.sickLeaves.push({
            start: start.toISOString(),
            end: end.toISOString()
        });
    }
}}

            const newEmployee = new Employee(formData);
            
            if (currentEmployeeIndex === -1) {
                employees.push(newEmployee);
            } else {
                employees[currentEmployeeIndex] = newEmployee;
            }

            saveData();
            generateCalendar();
            closeModal('editModal');
        }

        function deleteEmployee(index) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–±–æ—Ç–Ω–∏–∫–∞ "${employees[index].name}"?`)) {
                employees.splice(index, 1);
                saveData();
                generateCalendar();
            }
        }

        function exportToFile() {
            const data = {
                version: 3,
employees: employees.map(emp => ({
    number: emp.number,
    name: emp.name,
    scheduleType: emp.scheduleType,
    startDate: emp.startDate.toISOString(),
    vacation: emp.vacation,
    sickLeaves: emp.sickLeaves,
    customDaysOff: emp.customDaysOff,
    shortenedShifts: emp.shortenedShifts,
    carryOverHours: emp.carryOverHours  // –î–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤–æ–µ –ø–æ–ª–µ
})),
                lunchSettings: lunchSettings
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schedule_data.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function exportTable() {
            try {
                const originalTable = document.querySelector('#calendar table');
                if (!originalTable) throw new Error('–¢–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');

                const clonedTable = originalTable.cloneNode(true);
                clonedTable.querySelectorAll('.no-print, .employee-number, .action-buttons').forEach(el => el.remove());
                
                clonedTable.querySelectorAll('.employee-name').forEach(el => {
                    el.parentElement.innerHTML = el.textContent;
                });

                const ws = XLSX.utils.table_to_sheet(clonedTable);

                const headerRow = originalTable.tHead?.rows[0];
                const weekendColumns = [];
                if (headerRow) {
                    Array.from(headerRow.cells).forEach((cell, index) => {
                        if (cell.classList.contains('weekend')) weekendColumns.push(index);
                    });
                }

                const range = XLSX.utils.decode_range(ws['!ref']);
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                        if (!ws[cellAddress]) continue;

                        ws[cellAddress].s = {
                            alignment: {
                                horizontal: C === 0 ? 'left' : 'center',
                                vertical: 'center',
                                wrapText: true
                            },
                            font: { sz: 11 }
                        };

                        if (weekendColumns.includes(C)) {
                            ws[cellAddress].s.fill = {
                                patternType: "solid",
                                fgColor: { theme: 8, tint: 0.4 }
                            };
                        }

                        if (R === 0) {
                            ws[cellAddress].s.font.bold = true;
                        }
                    }
                }

                if (clonedTable.rows.length > 0) {
                    const firstRow = clonedTable.rows[0];
                    ws['!cols'] = Array.from(firstRow.cells).map((cell, index) => ({
                        wch: index === 0 ? 35 : 5
                    }));
                }

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "–ì—Ä–∞—Ñ–∏–∫ —Å–º–µ–Ω");
                XLSX.writeFile(wb, `–ì—Ä–∞—Ñ–∏–∫_—Å–º–µ–Ω_${new Date().toISOString().slice(0,10)}.xlsx`);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + error.message);
            }
        }

        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function saveData() {
            const data = {
                version: 3,
                employees: employees
                    .filter(emp => {
                        if (!validateEmployee(emp)) {
                            console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞–±–æ—Ç–Ω–∏–∫ –Ω–µ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω:", emp);
                            return false;
                        }
                        return true;
                    })
                    .map(emp => ({
                        number: emp.number,
                        name: emp.name,
                        scheduleType: emp.scheduleType,
                        startDate: emp.startDate.toISOString(),
                        vacation: emp.vacation,
                        sickLeaves: emp.sickLeaves,
                        customDaysOff: emp.customDaysOff,
                        shortenedShifts: emp.shortenedShifts
                    })),
                lunchSettings: lunchSettings
            };
            
            try {
                localStorage.setItem('scheduleAppData', JSON.stringify(data));
                console.log("–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:", e);
                alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ: " + e.message);
            }
        }

function saveLunchSettings() {
    document.querySelectorAll('#lunchTable input').forEach(input => {
        const key = input.dataset.schedule;
        const value = parseInt(input.value, 10) || 0;
        lunchSettings[key] = value;
    });
    saveData();
    generateCalendar(); // –î–æ–±–∞–≤–∏—Ç—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    closeModal('lunchModal');
}
let currentEditingShift = null;

function openShortenedModal() {
	// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –∏–Ω–¥–µ–∫—Å–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    if (currentEmployeeIndex === null || currentEmployeeIndex < 0 || currentEmployeeIndex >= employees.length) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞");
        return;
    }
    currentShortenedEmployee = employees[currentEmployeeIndex];
    refreshShortenedList();
    document.getElementById('shortenedModal').style.display = 'flex';
}

function refreshShortenedList() {
    const list = document.getElementById('shortenedList');
    list.innerHTML = '';
	if (!currentShortenedEmployee) {
        console.error("–ù–µ –≤—ã–±—Ä–∞–Ω —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è");
        return;
    }
    
    Object.entries(currentShortenedEmployee.shortenedShifts).forEach(([date, hours]) => {
        const item = document.createElement('div');
        item.className = 'shortened-item';
        
        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è UTC –¥–∞—Ç—ã –≤ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
        const utcDate = new Date(date + 'T00:00:00Z');
        const localDate = new Date(utcDate.getTime() - utcDate.getTimezoneOffset() * 60000);
        const dateStr = localDate.toLocaleDateString('ru-RU');
        
        item.innerHTML = `
            <span>${dateStr} - ${hours} —á</span>
            <div>
                <button onclick="editShortenedShift('${date}')">‚úèÔ∏è</button>
                <button onclick="deleteShortenedShift('${date}')">üóëÔ∏è</button>
            </div>
        `;
        
        list.appendChild(item);
    });
}

function addShortenedShift() {
    const dateInput = document.getElementById('shortenedDate');
    const hoursInput = document.getElementById('shortenedHours');
    
    const date = new Date(dateInput.value);
    if (isNaN(date.getTime())) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –¥–∞—Ç—É');
        return;
    }
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ UTC
    const utcDate = new Date(Date.UTC(
        date.getFullYear(),
        date.getMonth(),
        date.getDate()
    ));
    const isoDate = utcDate.toISOString().split('T')[0];
    
    if (currentEditingShift) {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–ø–∏—Å—å –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
        delete currentShortenedEmployee.shortenedShifts[currentEditingShift];
        currentEditingShift = null;
    }
    
    currentShortenedEmployee.shortenedShifts[isoDate] = parseFloat(hoursInput.value);
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
    dateInput.value = '';
    hoursInput.value = '7';
    document.getElementById('addShortenedBtn').textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å';
    
    refreshShortenedList();
    saveData();
    generateCalendar();
}

function editShortenedShift(dateKey) {
    const hours = currentShortenedEmployee.shortenedShifts[dateKey];
    
    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è UTC –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è input
    const utcDate = new Date(dateKey + 'T00:00:00Z');
    const localDate = new Date(utcDate.getTime() - utcDate.getTimezoneOffset() * 60000);
    const formattedDate = localDate.toISOString().split('T')[0];
    
    document.getElementById('shortenedDate').value = formattedDate;
    document.getElementById('shortenedHours').value = hours;
    currentEditingShift = dateKey;
    
    document.getElementById('addShortenedBtn').textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
}

function deleteShortenedShift(dateKey) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        delete currentShortenedEmployee.shortenedShifts[dateKey];
        refreshShortenedList();
        saveData();
        generateCalendar();
    }
}

        function openDatepicker() {
            currentDateInput = document.getElementById('customDaysOff');
            
selectedDates = currentDateInput.value.split(',')
    .map(d => {
        const parts = d.trim().match(/(\d{2})\.(\d{2})\.(\d{4})/);
        if (!parts) return null;
        // –°–æ–∑–¥–∞–µ–º –¥–∞—Ç—É –≤ UTC 
        return new Date(Date.UTC(parts[3], parts[2]-1, parts[1]));
    })
    .filter(d => d && !isNaN(d));

            const $datepicker = $('#datepicker');
            if ($datepicker.data('datepicker')) {
                $datepicker.data('datepicker').destroy();
            }
            
            $datepicker.datepicker({
                language: 'ru',
                dateFormat: 'dd.mm.yyyy',
                multipleDates: true,
                toggleSelected: false,
                selectedDates: selectedDates,
                onSelect: function(formattedDate, date) {
                    selectedDates = Array.isArray(date) ? date : [date];
                }
            });

            document.getElementById('datepickerModal').style.display = 'flex';
        }

        function addSelectedDates() {
            if (currentDateInput && selectedDates.length > 0) {
                const formattedDates = selectedDates
                    .map(d => {
                        const day = String(d.getDate()).padStart(2, '0');
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const year = d.getFullYear();
                        return `${day}.${month}.${year}`;
                    });
                currentDateInput.value = formattedDates.join(', ');
            } else {
                currentDateInput.value = '';
            }
            closeModal('datepickerModal');
        }

        function clearSelectedDates() {
            selectedDates = [];
            currentDateInput.value = '';
            $('#datepicker').datepicker().data('datepicker').clear();
            closeModal('datepickerModal');
        }


        document.addEventListener('DOMContentLoaded', () => {
            const savedData = localStorage.getItem('scheduleAppData');
            if (savedData) {
                try {
                    console.log("–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
                    const data = JSON.parse(savedData);
                    const migratedData = migrateData(data);
                    console.log("–î–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:", migratedData);

                    if (migratedData.version === 3) {
                        employees = migratedData.employees
                            .map(e => {
                                try {
                                    const emp = new Employee({
    ...e,
    carryOverHours: e.carryOverHours || {}  // –î–æ–±–∞–≤–∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å–∏–º—ã–µ —á–∞—Å—ã
});
                                    if (!validateEmployee(emp)) {
                                        console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞", e);
                                        return null;
                                    }
                                    return emp;
                                } catch (error) {
                                    console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:", e, error);
                                    return null;
                                }
                            })
                            .filter(emp => emp !== null);
                        
                        lunchSettings = migratedData.lunchSettings || {};
                        console.log(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${employees.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤`);
                    }
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', e);
                    localStorage.removeItem('scheduleAppData');
                }
            }

            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-theme');
            }

            generateCalendar();

            document.getElementById('lunchSettingsBtn').addEventListener('click', () => {
                document.querySelectorAll('#lunchTable input').forEach(input => {
                    const key = input.dataset.schedule;
                    input.value = lunchSettings[key] || 0;
                });
                document.getElementById('lunchModal').style.display = 'flex';
            });

            document.getElementById('fileInput').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        console.log("–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...");
                        const data = JSON.parse(event.target.result);
                        console.log("–î–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞:", data);

                        // –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
                        const migratedData = migrateData(data);
                        console.log("–î–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:", migratedData);

                        if (migratedData.version === 3) {
                            // –°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤
                            employees = migratedData.employees
                                .map(e => {
                                    try {
                                        const emp = new Employee(e);
                                        if (!validateEmployee(emp)) {
                                            console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç–Ω–∏–∫–∞", e);
                                            return null;
                                        }
                                        return emp;
                                    } catch (error) {
                                        console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–±–æ—Ç–Ω–∏–∫–∞:", e, error);
                                        return null;
                                    }
                                })
                                .filter(emp => emp !== null);
                            
                            lunchSettings = migratedData.lunchSettings || {};
                            
                            saveData();
                            generateCalendar();
                            alert(`–£—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ ${employees.length} —Ä–∞–±–æ—Ç–Ω–∏–∫–æ–≤`);
                        } else {
                            alert('–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–∞—è –≤–µ—Ä—Å–∏—è —Ñ–∞–π–ª–∞!');
                        }
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:", error);
                        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: ' + error.message);
                    } finally {
                        e.target.value = ''; // –°–±—Ä–æ—Å –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
                    }
                };
                reader.onerror = () => {
                    alert('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞');
                    e.target.value = '';
                };
                reader.readAsText(file);
            });
        });

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>